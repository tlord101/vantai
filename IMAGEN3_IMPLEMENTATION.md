# Imagen 3 Implementation Guide

## Overview
VanTai Image Editor now uses **Imagen 3** (via `gemini-3-pro-image-preview` model) for AI-powered image generation and editing, replacing the previous Gemini text-based analysis.

## Implementation Details

### 1. SDK Installation
```bash
npm install @google/genai
```

**Package**: `@google/genai` (v1.0+)
**Added**: 44 packages, total 379 packages

### 2. Service Architecture

#### File: `src/services/gemini.ts`

**Key Features**:
- Uses `GoogleGenAI` from `@google/genai` SDK
- Model: `gemini-3-pro-image-preview` (Imagen 3)
- Supports both text-to-image and image-to-image generation
- Returns base64-encoded images as data URLs

**Main Methods**:

```typescript
class ImagenService {
  // Generate image from text prompt (with optional reference image)
  async generateImage(prompt: string, referenceImage?: File): Promise<string>
  
  // Wrapper method for chat interface
  async sendMessage(text: string, image?: File): Promise<{ 
    text: string; 
    generatedImage?: string 
  }>
}
```

**Configuration**:
```typescript
const response = await ai.models.generateContent({
  model: 'gemini-3-pro-image-preview',
  contents: enhancedPrompt,
  config: {
    tools: [{ googleSearch: {} }],
    imageConfig: {
      aspectRatio: '16:9',
      imageSize: '4K',
    },
  },
});
```

**Response Handling**:
- Extracts base64 image data from `response.candidates[0].content.parts[].inlineData.data`
- Returns as `data:image/png;base64,{imageData}` for direct display

### 3. Message Interface

```typescript
export interface Message {
  id: string;
  text: string;
  sender: 'user' | 'ai';
  timestamp: Date;
  image?: string;           // User-uploaded reference image
  generatedImage?: string;   // AI-generated result image
}
```

### 4. App Integration

#### File: `src/App.tsx`

**Flow**:
1. User submits prompt (with or without reference image)
2. Check subscription plan and daily limits
3. Call `geminiService.sendMessage()`
4. Increment image generation count
5. Display generated image in chat

**Image Generation Logic**:
```typescript
const response = await geminiService.sendMessage(
  text || 'Generate a creative image based on this reference.',
  image
);

const aiMessage: Message = {
  id: (Date.now() + 1).toString(),
  text: response.text,
  sender: 'ai',
  timestamp: new Date(),
  generatedImage: response.generatedImage,  // Base64 data URL
};
```

### 5. UI Display

#### File: `src/components/MessageList.tsx`

**Generated Image Display**:
```typescript
{message.generatedImage && (
  <motion.div>
    <div className="rounded-lg overflow-hidden border border-white/20 shadow-xl">
      <img
        src={message.generatedImage}  // data:image/png;base64,...
        alt="AI Generated"
        className="w-full h-auto object-cover"
      />
      <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 px-3 py-2">
        ‚ú® Generated by Imagen 3
      </div>
    </div>
  </motion.div>
)}
```

## API Configuration

### Environment Variables
```env
VITE_GEMINI_API_KEY=AIzaSyAKYD_WAnLedgm7B_GPA5VcxmUIBdvVs9U
```

### Requirements
- Google Cloud Project with Imagen 3 API enabled
- Valid API key with Gemini access
- Network access to Google AI endpoints

## Features

### Text-to-Image Generation
**User sends**: "A serene mountain landscape at sunset with dramatic clouds"
**System**:
- Calls Imagen 3 with enhanced prompt
- Generates 4K image (16:9 aspect ratio)
- Returns as base64 data URL
- Displays in chat with "Generated by Imagen 3" badge

### Image-to-Image Editing
**User uploads**: Reference photo + prompt "Make this photo look vintage with warm sepia tones"
**System**:
- Enhances prompt: "Edit and enhance this image: {user_prompt}. Maintain the original composition..."
- Generates edited version
- Preserves composition while applying requested changes

## Subscription Integration

### Daily Limits
- **Free Plan**: No image generation (blocked)
- **Basic Plan (‚Ç¶15,000)**: 10 images per day
- **Premium Plan (‚Ç¶25,000)**: Unlimited images

### Tracking
- Counter incremented in Firestore after each successful generation
- Resets at midnight UTC
- Checks performed before generation

## Error Handling

### Common Errors
1. **"No candidates in response"**: API returned empty result
2. **"Invalid response structure"**: Unexpected API response format
3. **"Failed to generate image"**: General API error

### User Feedback
```typescript
return {
  text: `‚ùå Image generation failed: ${error.message}\n\nüí° Tips:\n‚Ä¢ Make sure your API key is valid\n‚Ä¢ Ensure Imagen 3 API is enabled in Google Cloud\n‚Ä¢ Try a different prompt`
};
```

## Testing

### Test Scenarios

1. **Text-to-Image**
   - Input: "A futuristic city at night with neon lights"
   - Expected: AI message with generatedImage field containing base64 data URL

2. **Image-to-Image**
   - Input: Upload photo + "Add dramatic lighting"
   - Expected: Edited version maintaining original composition

3. **Subscription Limits**
   - Basic plan: 10th generation succeeds, 11th blocked
   - Premium plan: Unlimited (no blocking)

4. **Error Cases**
   - Invalid API key: Error message with troubleshooting tips
   - Network failure: Retry prompt displayed

## Migration from Previous Implementation

### Changed
- ‚ùå **Removed**: `@google/generative-ai` package
- ‚úÖ **Added**: `@google/genai` package
- ‚ùå **Removed**: Text-based analysis mode
- ‚úÖ **Added**: Actual image generation
- üîÑ **Updated**: All prompts now return images instead of instructions

### Backward Compatibility
- Message interface extended (not broken)
- Chat history preserved with new `generatedImage` field
- Existing messages display normally

## Performance Considerations

- **Image Size**: 4K images are large (2-5MB base64)
- **Loading**: Use lazy loading for generated images
- **Storage**: localStorage may fill up with chat history
- **Recommendation**: Consider implementing image cleanup for old messages

## Future Enhancements

1. **Image Download**: Add button to download generated images
2. **Image History**: Separate gallery for generated images
3. **Batch Generation**: Generate multiple variations
4. **Advanced Settings**: Expose aspect ratio and size controls
5. **Image Compression**: Optimize base64 storage

## Troubleshooting

### "Module '@google/genai' not found"
```bash
rm -rf node_modules package-lock.json
npm install
```

### "API key invalid"
- Verify key in Google Cloud Console
- Check Imagen 3 API is enabled
- Ensure billing is set up

### "No image generated in response"
- Check API quota limits
- Verify prompt doesn't violate content policies
- Try simpler prompt

## References

- [Google GenAI SDK Documentation](https://ai.google.dev/gemini-api/docs/imagen)
- [Imagen 3 Model Card](https://deepmind.google/technologies/imagen-3/)
- VanTai Subscription Guide: `SUBSCRIPTION_GUIDE.md`

---

**Implementation Date**: January 2025  
**Model**: gemini-3-pro-image-preview (Imagen 3)  
**Status**: ‚úÖ Active and functional
